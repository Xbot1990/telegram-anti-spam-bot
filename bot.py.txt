# -*- coding: utf-8 -*-
import logging
import re
import asyncio
import signal
import sys
from datetime import datetime, timedelta
from telegram import Update
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters
)
from telegram.error import TelegramError

# === –î–õ–Ø WEB-–°–ï–†–í–ï–†–ê ===
from flask import Flask
import threading
# ========================

# === –ù–ê–®–ò –ú–û–î–£–õ–ò ===
from config import TOKEN, CREATOR_ID, DEFAULT_SETTINGS, TARIFFS
from database import Database
from keyboards import (
    get_main_menu, get_tariffs_menu, get_tariff_details,
    get_payment_methods, get_settings_menu, get_setting_toggle,
    get_flood_settings, get_payment_confirmation_buttons,
    get_decline_reason_buttons, get_ban_details_buttons,
    get_ban_full_details_buttons, get_back_button,
    get_tags_menu, get_actions_menu
)
from tariffs import TariffSystem
# ===================

# ================== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==================
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==================
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
db = Database()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É —Ç–∞—Ä–∏—Ñ–æ–≤
tariff_system = TariffSystem(db)

# –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
spam_detection = {}
current_payments = {}
group_settings_cache = {}

def signal_handler(signum, frame):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown"""
    print(f"\n‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {signum}. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞...")
    db.save_cache()
    print("üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
    sys.exit(0)

# ================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==================

def get_group_settings(group_id):
    """–ü–æ–ª—É—á–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã"""
    if group_id in group_settings_cache:
        return group_settings_cache[group_id]
    
    group = db.get_group(group_id)
    if group and "–Ω–∞—Å—Ç—Ä–æ–π–∫–∏" in group:
        settings = group["–Ω–∞—Å—Ç—Ä–æ–π–∫–∏"]
        group_settings_cache[group_id] = settings
        return settings
    
    return DEFAULT_SETTINGS.copy()

def save_group_settings(group_id, settings):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã"""
    group_settings_cache[group_id] = settings
    db.update_group_settings(group_id, settings)

def get_admin_info(admin_id, update=None):
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥–º–∏–Ω–µ"""
    admin = db.get_admin(admin_id)
    if not admin:
        username = ""
        first_name = ""
        if update and update.effective_user:
            username = update.effective_user.username or ""
            first_name = update.effective_user.first_name or ""
        admin = db.create_admin(admin_id, username, first_name)
    return admin

def is_admin(user_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º"""
    if user_id == CREATOR_ID:
        return True
    admin = db.get_admin(user_id)
    return admin is not None

def detect_flood(user_id: int, chat_id: int, limit: int = 5) -> bool:
    """–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Ñ–ª—É–¥–∞"""
    now = datetime.now()
    key = f"{chat_id}_{user_id}"
    
    spam_detection.setdefault(key, [])
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ (—Å—Ç–∞—Ä—à–µ 10 —Å–µ–∫—É–Ω–¥)
    spam_detection[key] = [t for t in spam_detection[key] if now - t < timedelta(seconds=10)]
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    spam_detection[key].append(now)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
    return len(spam_detection[key]) >= limit

def contains_suspicious_links(text: str, allowed_domains: list) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫"""
    if not text:
        return False
    
    # –ò—â–µ–º –≤—Å–µ URL –≤ —Ç–µ–∫—Å—Ç–µ
    url_pattern = r'(?:https?://|www\.|t\.me/|bit\.ly/|tinyurl\.com/|t\.co/)[^\s]+'
    urls = re.findall(url_pattern, text.lower())
    
    for url in urls:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à—ë–Ω –ª–∏ –¥–æ–º–µ–Ω
        is_allowed = False
        for domain in allowed_domains:
            if domain in url:
                is_allowed = True
                break
        
        # –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞
        if not is_allowed:
            return True
    
    return False

# ================== –°–ò–°–¢–ï–ú–ê –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ô ==================

async def warn_user(update: Update, context: ContextTypes.DEFAULT_TYPE, reason: str):
    """–í—ã–¥–∞—ë—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    user_id = update.effective_user.id
    chat_id = update.effective_chat.id
    name = update.effective_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤)
    message_text = ""
    if update.message and update.message.text:
        message_text = update.message.text[:200]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Ä—É—à–µ–Ω–∏–µ –≤ –±–∞–∑—É
    warnings_count = db.add_violation(chat_id, user_id, reason, message_text)
    
    # –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    try:
        await update.message.delete()
    except TelegramError:
        pass
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
    if warnings_count >= 3:
        # –ë–ê–ù –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            await update.effective_chat.ban_member(user_id)
            
            # –°–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ
            ban_message = f"üö´ {name} –∑–∞–±–∞–Ω–µ–Ω –∑–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è (–ø–æ—Å–ª–µ–¥–Ω–µ–µ: {reason})"
            await update.effective_chat.send_message(ban_message)
            
            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
            await send_ban_notification_to_admin(
                context.bot,
                user_id,
                name,
                reason,
                chat_id,
                update.effective_chat.title
            )
            
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞—Ä—É—à–µ–Ω–∏—è
            db.reset_violations(chat_id, user_id)
            
        except TelegramError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–∞–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
    else:
        # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        warning_text = f"‚ö†Ô∏è {name}, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ {warnings_count}/3 ({reason})"
        await update.effective_chat.send_message(warning_text)

async def send_ban_notification_to_admin(bot, user_id, user_name, reason, chat_id, chat_title):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–∞–Ω–µ –∞–¥–º–∏–Ω—É"""
    group = db.get_group(chat_id)
    if not group:
        return
    
    admin_id = group.get("admin_id")
    if not admin_id:
        return
    
    try:
        message = f"üö´ **–ó–ê–ë–ê–ù–ï–ù –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨**\n\n"
        message += f"üë§ **–ò–º—è:** {user_name}\n"
        message += f"üÜî **ID:** {user_id}\n"
        message += f"üìç **–ì—Ä—É–ø–ø–∞:** {chat_title}\n"
        message += f"üéØ **–ü—Ä–∏—á–∏–Ω–∞:** {reason} (3 –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è)\n"
        message += f"‚è∞ **–í—Ä–µ–º—è:** {datetime.now().strftime('%H:%M')}"
        
        await bot.send_message(
            chat_id=admin_id,
            text=message,
            reply_markup=get_ban_details_buttons(user_id, chat_id),
            parse_mode="Markdown"
        )
        
    except TelegramError as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É {admin_id}: {e}")

# ================== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==================

async def analyze_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è"""
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–Ω–∞–ª—ã
    if update.effective_chat.type == "channel":
        return
    
    user_id = update.effective_user.id
    chat_id = update.effective_chat.id
    
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω–æ–≤
    if is_admin(user_id):
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã
    settings = get_group_settings(chat_id)
    text = update.message.text or update.message.caption or ""
    text_lower = text.lower()
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–ª—É–¥
    if settings["—Ñ–ª—É–¥"]["–≤–∫–ª—é—á–µ–Ω–æ"]:
        if detect_flood(user_id, chat_id, settings["—Ñ–ª—É–¥"]["–ª–∏–º–∏—Ç"]):
            await warn_user(update, context, "–§–ª—É–¥")
            return
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∞—Ç
    if settings["–∞–Ω—Ç–∏–º–∞—Ç"]["–≤–∫–ª—é—á–µ–Ω–æ"]:
        bad_words = settings["–∞–Ω—Ç–∏–º–∞—Ç"]["—Å–ø–∏—Å–æ–∫_—Å–ª–æ–≤"]
        for word in bad_words:
            if word in text_lower:
                await warn_user(update, context, "–ú–∞—Ç")
                return
    
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ø–∞–º
    if settings["–∞–Ω—Ç–∏—Å–ø–∞–º"]["–≤–∫–ª—é—á–µ–Ω–æ"]:
        spam_words = settings["–∞–Ω—Ç–∏—Å–ø–∞–º"]["—Å–ø–∏—Å–æ–∫_—Å–ª–æ–≤"]
        for word in spam_words:
            if word in text_lower:
                await warn_user(update, context, "–°–ø–∞–º")
                return
    
    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ–∫
    if settings["—Å—Å—ã–ª–∫–∏"]["–≤–∫–ª—é—á–µ–Ω–æ"] and text:
        if contains_suspicious_links(text, settings["—Å—Å—ã–ª–∫–∏"]["–±–µ–ª—ã–π_—Å–ø–∏—Å–æ–∫"]):
            await warn_user(update, context, "–ó–∞–ø—Ä–µ—â—ë–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞")
            return

# ================== –ö–û–ú–ê–ù–î–´ ==================

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = update.effective_user.id
    admin = get_admin_info(user_id, update)
    
    welcome_text = "ü§ñ **ANTI-SPAM BOT PREMIUM**\n\n"
    welcome_text += f"üëã –ü—Ä–∏–≤–µ—Ç, {update.effective_user.first_name}!\n"
    welcome_text += "–Ø –ø–æ–º–æ–≥—É –∑–∞—â–∏—Ç–∏—Ç—å –≤–∞—à—É –≥—Ä—É–ø–ø—É –æ—Ç —Å–ø–∞–º–∞, –º–∞—Ç–∞ –∏ —Ñ–ª—É–¥–∞.\n\n"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ
    tariff_type = tariff_system.get_tariff_for_admin(user_id)
    tariff_desc = tariff_system.get_tariff_description(tariff_type)
    
    await update.message.reply_text(
        welcome_text + tariff_desc,
        reply_markup=get_main_menu(),
        parse_mode="Markdown"
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = "üìñ **–ü–û–ú–û–©–¨**\n\n"
    help_text += "**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n"
    help_text += "/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º\n"
    help_text += "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
    help_text += "/tariffs - –¢–∞—Ä–∏—Ñ—ã –∏ —Ü–µ–Ω—ã\n"
    help_text += "/settings - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞\n\n"
    help_text += "**–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–æ—á–Ω–æ–µ –º–µ–Ω—é.\n"
    help_text += "**–î–ª—è –æ–ø–ª–∞—Ç—ã** –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º."
    
    await update.message.reply_text(help_text, parse_mode="Markdown")

async def tariffs_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /tariffs"""
    tariffs_text = "üí∞ **–¢–ê–†–ò–§–´ –ò –¶–ï–ù–´**\n\n"
    tariffs_text += "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:\n"
    
    await update.message.reply_text(
        tariffs_text,
        reply_markup=get_tariffs_menu(),
        parse_mode="Markdown"
    )

async def settings_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /settings"""
    user_id = update.effective_user.id
    admin = get_admin_info(user_id, update)
    
    if not admin["–≥—Ä—É–ø–ø—ã"]:
        await update.message.reply_text(
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø.\n"
            "–î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É —Å–Ω–∞—á–∞–ª–∞, –∑–∞—Ç–µ–º –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞—â–∏—Ç—É."
        )
        return
    
    await update.message.reply_text(
        "‚öôÔ∏è **–ù–ê–°–¢–†–û–ô–ö–ò –ó–ê–©–ò–¢–´**\n\n"
        "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞—â–∏—Ç—ã:",
        reply_markup=get_settings_menu(),
        parse_mode="Markdown"
    )

# ================== –û–ë–†–ê–ë–û–¢–ö–ê CALLBACK ==================

async def handle_callback_query(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    user_id = query.from_user.id
    
    logger.info(f"Callback –æ—Ç {user_id}: {data}")
    
    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    if data == "back_to_main":
        await show_main_menu(query, user_id)
    elif data == "tariffs":
        await show_tariffs_menu(query)
    elif data == "settings":
        await show_settings_menu(query, user_id)
    
    # –¢–∞—Ä–∏—Ñ—ã
    elif data == "back_to_tariffs":
        await show_tariffs_menu(query)
    elif data.startswith("tariff_"):
        await handle_tariff_selection(query, data)
    
    # –û–ø–ª–∞—Ç–∞
    elif data.startswith("pay_"):
        await handle_payment_selection(query, data, user_id)
    elif data in ["pay_sber", "pay_tinkoff"]:
        await handle_payment_method(query, data, user_id)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    elif data.startswith("setting_"):
        await handle_setting_selection(query, data, user_id)
    elif data.startswith("toggle_"):
        await handle_toggle_setting(query, data, user_id)
    elif data.startswith("flood_"):
        await handle_flood_setting(query, data, user_id)
    elif data == "back_to_settings":
        await show_settings_menu(query, user_id)
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã (–¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è)
    elif data.startswith("confirm_"):
        await handle_payment_confirmation(query, data, user_id, context)
    elif data.startswith("decline_"):
        await handle_payment_decline(query, data, user_id)
    elif data.startswith("check_"):
        await handle_check_screenshot(query, data, context)
    elif data.startswith("tags_"):
        await handle_tags_menu(query, data)
    elif data.startswith("stats_"):
        await handle_statistics(query, data)
    elif data.startswith("actions_"):
        await handle_actions_menu(query, data)
    elif data.startswith("tag_"):
        await handle_add_tag(query, data)
    elif data.startswith("action_"):
        await handle_admin_action(query, data, context)
    
    # –ë–∞–Ω—ã
    elif data.startswith("unban_"):
        await handle_unban(query, data, context)
    elif data.startswith("bandetails_"):
        await handle_ban_details(query, data)
    
    # üîß –î–û–ë–ê–í–õ–ï–ù–û: –ù–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    elif data == "back_to_tariff":
        await show_tariffs_menu(query)
    
    elif data == "activate_trial":
        admin = get_admin_info(user_id)
        if admin["—Ç–∞—Ä–∏—Ñ"] == "trial":
            await query.answer("‚úÖ –ü—Ä–æ–±–Ω—ã–π —Ç–∞—Ä–∏—Ñ —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!", show_alert=True)
        else:
            db.update_admin_tariff(user_id, "trial", 30)
            await query.answer("üéÅ –ü—Ä–æ–±–Ω—ã–π —Ç–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ 30 –¥–Ω–µ–π!", show_alert=True)
            await show_main_menu(query, user_id)
    
    elif data == "setting_flood":
        await handle_setting_selection(query, data, user_id)
    
    elif data.startswith("back_to_"):
        destination = data.replace("back_to_", "")
        if destination == "main":
            await show_main_menu(query, user_id)
        elif destination == "tariffs":
            await show_tariffs_menu(query)
        elif destination == "settings":
            await show_settings_menu(query, user_id)
        elif destination.startswith("payment_"):
            payment_id = destination.replace("payment_", "")
            payment = db.data["–ø–ª–∞—Ç–µ–∂–∏"].get(payment_id)
            if payment:
                message = f"üí∞ **–û–ü–õ–ê–¢–ê** #{payment_id}\n\n"
                message += f"üë§ **–ê–¥–º–∏–Ω ID:** {payment['admin_id']}\n"
                message += f"üí≥ **–¢–∞—Ä–∏—Ñ:** {payment['—Ç–∞—Ä–∏—Ñ']}\n"
                message += f"üí∞ **–°—É–º–º–∞:** {payment['—Å—É–º–º–∞']} —Ä—É–±\n"
                message += f"üìÖ **–ü–µ—Ä–∏–æ–¥:** {payment['–ø–µ—Ä–∏–æ–¥']}\n"
                message += f"‚è∞ **–í—Ä–µ–º—è:** {payment['—Å–æ–∑–¥–∞–Ω']}\n"
                message += f"üìä **–°—Ç–∞—Ç—É—Å:** {payment['—Å—Ç–∞—Ç—É—Å']}"
                
                await query.edit_message_text(
                    message,
                    reply_markup=get_payment_confirmation_buttons(payment_id),
                    parse_mode="Markdown"
                )
    
    elif data.startswith("bandetails_back_"):
        parts = data.split("_")
        if len(parts) == 4:
            user_id_ban = int(parts[2])
            group_id = int(parts[3])
            
            violations_data = db.get_violations(group_id, user_id_ban)
            
            details_text = "üîç **–ü–û–î–†–û–ë–ù–û–°–¢–ò –ë–ê–ù–ê**\n\n"
            details_text += f"üë§ **ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** {user_id_ban}\n"
            details_text += f"üìç **–ì—Ä—É–ø–ø–∞ ID:** {group_id}\n\n"
            
            if violations_data["–Ω–∞—Ä—É—à–µ–Ω–∏—è"]:
                details_text += "üìù **–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏–π:**\n"
                for i, violation in enumerate(violations_data["–Ω–∞—Ä—É—à–µ–Ω–∏—è"], 1):
                    time = datetime.fromisoformat(violation["–≤—Ä–µ–º—è"]).strftime("%H:%M")
                    reason = violation["–ø—Ä–∏—á–∏–Ω–∞"]
                    message = violation["—Å–æ–æ–±—â–µ–Ω–∏–µ"]
                    
                    details_text += f"{i}. {time} ‚Äî {reason}\n"
                    if message:
                        details_text += f"   üí¨ {message[:50]}...\n"
            else:
                details_text += "üìù –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç\n\n"
            
            details_text += f"\nüéØ **–í—Å–µ–≥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π:** {violations_data['–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è']}/3"
            
            await query.edit_message_text(
                details_text,
                reply_markup=get_ban_full_details_buttons(user_id_ban, group_id),
                parse_mode="Markdown"
            )
    
    elif data.startswith("decline_"):
        parts = data.split("_")
        if len(parts) == 3:  # decline_reason_paymentid
            reason_type = parts[1]
            payment_id = parts[2]
            
            reason_texts = {
                "amount": "–Ω–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞",
                "nocomment": "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
                "badscreen": "–Ω–µ—á–∏—Ç–∞–µ–º—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç"
            }
            
            reason = reason_texts.get(reason_type, reason_type)
            db.update_payment(payment_id, f"–æ—Ç–∫–ª–æ–Ω–µ–Ω: {reason}")
            
            payment = db.data["–ø–ª–∞—Ç–µ–∂–∏"].get(payment_id)
            if payment:
                try:
                    await context.bot.send_message(
                        chat_id=payment["admin_id"],
                        text=f"‚ùå **–û–ü–õ–ê–¢–ê –û–¢–ö–õ–û–ù–ï–ù–ê**\n\n"
                             f"–ü—Ä–∏—á–∏–Ω–∞: {reason}\n\n"
                             f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
                    )
                except:
                    pass
            
            await query.edit_message_text(
                f"‚ùå **–ü–õ–ê–¢–Å–ñ –û–¢–ö–õ–û–ù–ï–ù**\n\n"
                f"–ü—Ä–∏—á–∏–Ω–∞: {reason}\n\n"
                f"–ê–¥–º–∏–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω.",
                reply_markup=None
            )
        else:
            await handle_payment_decline(query, data, user_id)
    
    elif data == "support":
        await query.edit_message_text(
            "üìû **–ü–û–î–î–ï–†–ñ–ö–ê**\n\n"
            "–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å:\n"
            "‚Ä¢ –í –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: @creator_username\n"
            "‚Ä¢ Email: support@example.com\n\n"
            "–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: –¥–æ 24 —á–∞—Å–æ–≤\n"
            "–†–∞–±–æ—Ç–∞–µ–º 24/7",
            reply_markup=get_back_button("main"),
            parse_mode="Markdown"
        )
    
    else:
        await query.edit_message_text("‚è≥ –§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...")

async def show_main_menu(query, user_id):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    admin = get_admin_info(user_id)
    
    welcome_text = f"üëã –ü—Ä–∏–≤–µ—Ç, {query.from_user.first_name}!\n"
    welcome_text += f"–í–∞—à —Ç–∞—Ä–∏—Ñ: {admin.get('—Ç–∞—Ä–∏—Ñ', '–ü—Ä–æ–±–Ω—ã–π').upper()}\n\n"
    welcome_text += "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    
    await query.edit_message_text(
        welcome_text,
        reply_markup=get_main_menu()
    )

async def show_tariffs_menu(query):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Ç–∞—Ä–∏—Ñ–æ–≤"""
    tariffs_text = "üí∞ **–í–´–ë–ï–†–ò–¢–ï –¢–ê–†–ò–§**\n\n"
    
    for tariff_type, tariff in TARIFFS.items():
        emoji = "üéÅ" if tariff_type == "trial" else "üü¢" if tariff_type == "standard" else "üü°" if tariff_type == "pro" else "üî¥"
        name = tariff["name"]
        
        if tariff_type == "trial":
            price_text = "30 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ"
        else:
            price_text = f"–æ—Ç {tariff['price_month']} —Ä—É–±/–º–µ—Å"
        
        tariffs_text += f"{emoji} **{name}** - {price_text}\n"
        tariffs_text += f"   ‚Ä¢ {tariff['features'][0]}\n"
        if len(tariff['features']) > 1:
            tariffs_text += f"   ‚Ä¢ {tariff['features'][1]}\n"
        tariffs_text += "\n"
    
    tariffs_text += "‚ÑπÔ∏è –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç–∞—Ä–∏—Ñ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
    
    await query.edit_message_text(
        tariffs_text,
        reply_markup=get_tariffs_menu(),
        parse_mode="Markdown"
    )

async def show_settings_menu(query, user_id):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
    admin = get_admin_info(user_id)
    
    if not admin["–≥—Ä—É–ø–ø—ã"]:
        await query.edit_message_text(
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø.\n"
            "–î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É —Å–Ω–∞—á–∞–ª–∞.",
            reply_markup=get_back_button("main")
        )
        return
    
    settings_text = "‚öôÔ∏è **–ù–ê–°–¢–†–û–ô–ö–ò –ë–û–¢–ê**\n\n"
    settings_text += "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞—â–∏—Ç—É –¥–ª—è –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã:\n"
    settings_text += "‚Ä¢ –í–∫–ª—é—á–∏—Ç–µ/–≤—ã–∫–ª—é—á–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏\n"
    settings_text += "‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã\n"
    settings_text += "‚Ä¢ –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏\n\n"
    settings_text += "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:"
    
    await query.edit_message_text(
        settings_text,
        reply_markup=get_settings_menu(),
        parse_mode="Markdown"
    )

async def handle_tariff_selection(query, data):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞"""
    tariff_type = data.replace("tariff_", "")
    description = tariff_system.get_tariff_description(tariff_type)
    keyboard = get_tariff_details(tariff_type)
    
    await query.edit_message_text(
        description,
        reply_markup=keyboard,
        parse_mode="Markdown"
    )

async def handle_payment_selection(query, data, user_id):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –æ–ø–ª–∞—Ç—ã"""
    parts = data.split("_")
    if len(parts) != 3:
        await query.edit_message_text("‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –æ–ø–ª–∞—Ç—ã")
        return
    
    tariff_type = parts[1]
    period = parts[2]
    
    payment_data = tariff_system.process_payment_selection(user_id, tariff_type, period)
    if not payment_data:
        await query.edit_message_text("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞")
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞
    current_payments[user_id] = payment_data
    
    payment_text = f"üí≥ **–û–ü–õ–ê–¢–ê –¢–ê–†–ò–§–ê**\n\n"
    payment_text += f"–¢–∞—Ä–∏—Ñ: {payment_data['tariff']}\n"
    payment_text += f"–ü–µ—Ä–∏–æ–¥: {payment_data['period_text']}\n"
    payment_text += f"–°—É–º–º–∞: {payment_data['amount']} —Ä—É–±\n\n"
    payment_text += "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:"
    
    await query.edit_message_text(
        payment_text,
        reply_markup=get_payment_methods(),
        parse_mode="Markdown"
    )

async def handle_payment_method(query, data, user_id):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã"""
    if user_id not in current_payments:
        await query.edit_message_text("‚ùå –ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        return
    
    payment_data = current_payments[user_id]
    method = data.replace("pay_", "")
    
    if method == "sber":
        bank_name = "–°–±–µ—Ä–±–∞–Ω–∫"
        card = "2202 2081 **** 5663"
    else:  # tinkoff
        bank_name = "–¢–∏–Ω—å–∫–æ—Ñ—Ñ"
        card = "2200 7013 **** 4292"
    
    instructions = f"üè¶ **–û–ü–õ–ê–¢–ê {bank_name.upper()}**\n\n"
    instructions += f"**–ö–∞—Ä—Ç–∞:** {card}\n"
    instructions += f"**–ü–æ–ª—É—á–∞—Ç–µ–ª—å:** –í–∏–≥–µ–Ω.–ú\n"
    instructions += f"**–°—É–º–º–∞:** {payment_data['amount']} —Ä—É–±\n"
    instructions += "**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:** –≤–∞—à @username\n\n"
    instructions += "‚ö†Ô∏è **–ò–ù–°–¢–†–£–ö–¶–ò–Ø:**\n"
    instructions += "1. –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É\n"
    instructions += "2. –í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à @username\n"
    instructions += "3. –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞\n"
    instructions += "4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –≤ —ç—Ç–æ—Ç —á–∞—Ç\n\n"
    instructions += "üì∏ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞"
    
    await query.edit_message_text(
        instructions,
        parse_mode="Markdown"
    )

async def handle_setting_selection(query, data, user_id):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
    setting_name = data.replace("setting_", "")
    
    admin = get_admin_info(user_id)
    if not admin["–≥—Ä—É–ø–ø—ã"]:
        await query.edit_message_text(
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø.",
            reply_markup=get_back_button("settings")
        )
        return
    
    group_id = admin["–≥—Ä—É–ø–ø—ã"][0]["id"]
    settings = get_group_settings(group_id)
    
    if setting_name == "flood":
        current_limit = settings["—Ñ–ª—É–¥"]["–ª–∏–º–∏—Ç"]
        flood_text = "üí¨ **–ù–ê–°–¢–†–û–ô–ö–ê –§–õ–£–î-–ö–û–ù–¢–†–û–õ–Ø**\n\n"
        flood_text += "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ 10 —Å–µ–∫—É–Ω–¥.\n\n"
        flood_text += f"–¢–µ–∫—É—â–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞: {current_limit} —Å–æ–æ–±—â–µ–Ω–∏–π / 10 —Å–µ–∫\n\n"
        flood_text += "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ª–∏–º–∏—Ç:"
        
        await query.edit_message_text(
            flood_text,
            reply_markup=get_flood_settings(current_limit),
            parse_mode="Markdown"
        )
    else:
        setting_data = settings.get(setting_name, {})
        is_enabled = setting_data.get("–≤–∫–ª—é—á–µ–Ω–æ", False)
        
        setting_texts = {
            "antispam": "–ê–ù–¢–ò–°–ü–ê–ú",
            "antimat": "–ê–ù–¢–ò–ú–ê–¢",
            "links": "–ó–ê–©–ò–¢–ê –û–¢ –°–°–´–õ–û–ö",
            "new": "–ü–†–û–í–ï–†–ö–ê –ù–û–í–´–• –ê–ö–ö–ê–£–ù–¢–û–í",
            "smart": "–£–ú–ù–´–ô –†–ï–ñ–ò–ú",
            "analytics": "–ê–ù–ê–õ–ò–¢–ò–ö–ê",
            "notify": "–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –ê–î–ú–ò–ù–£"
        }
        
        descriptions = {
            "antispam": "–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∞–º-—Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —Å–ø–∏—Å–∫—É —Å–ª–æ–≤.",
            "antimat": "–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–∞—Ç–µ—Ä–Ω—ã—Ö —Å–ª–æ–≤.",
            "links": "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Å–∞–π—Ç–æ–≤.",
            "new": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (–≤–æ–∑—Ä–∞—Å—Ç, –∞–≤–∞—Ç–∞—Ä–∫–∞).",
            "smart": "–£–º–Ω—ã–π —Ä–µ–∂–∏–º —Å –æ–±—É—á–µ–Ω–∏–µ–º –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º –æ–±—Ö–æ–¥–æ–≤.",
            "analytics": "–°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞.",
            "notify": "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É –æ –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö –≤ –õ–°."
        }
        
        text = f"‚öôÔ∏è **{setting_texts.get(setting_name, setting_name.upper())}**\n\n"
        text += descriptions.get(setting_name, "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏.") + "\n\n"
        text += f"–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: {'‚úÖ –í–ö–õ–Æ–ß–ï–ù–û' if is_enabled else '‚ùå –í–´–ö–õ–Æ–ß–ï–ù–û'}"
        
        await query.edit_message_text(
            text,
            reply_markup=get_setting_toggle(setting_name, is_enabled)
        )

async def handle_toggle_setting(query, data, user_id):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
    parts = data.split("_")
    if len(parts) != 3:
        await query.edit_message_text("‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è")
        return
    
    setting_name = parts[1]
    new_state = parts[2]
    
    admin = get_admin_info(user_id)
    if not admin["–≥—Ä—É–ø–ø—ã"]:
        await query.edit_message_text("‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø")
        return
    
    group_id = admin["–≥—Ä—É–ø–ø—ã"][0]["id"]
    settings = get_group_settings(group_id)
    
    if setting_name in settings:
        settings[setting_name]["–≤–∫–ª—é—á–µ–Ω–æ"] = (new_state == "on")
        save_group_settings(group_id, settings)
        
        is_enabled = settings[setting_name]["–≤–∫–ª—é—á–µ–Ω–æ"]
        state_text = "–≤–∫–ª—é—á–µ–Ω–∞" if is_enabled else "–≤—ã–∫–ª—é—á–µ–Ω–∞"
        emoji = "‚úÖ" if is_enabled else "‚ùå"
        
        confirm_text = f"{emoji} –ù–∞—Å—Ç—Ä–æ–π–∫–∞ **{setting_name}** {state_text}!\n\n"
        confirm_text += "–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫–æ –≤—Å–µ–º –≤–∞—à–∏–º –≥—Ä—É–ø–ø–∞–º."
        
        await query.edit_message_text(
            confirm_text,
            reply_markup=get_back_button("settings"),
            parse_mode="Markdown"
        )
    else:
        await query.edit_message_text("‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

async def handle_flood_setting(query, data, user_id):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Ñ–ª—É–¥-–∫–æ–Ω—Ç—Ä–æ–ª—è"""
    limit_str = data.replace("flood_", "")
    
    admin = get_admin_info(user_id)
    if not admin["–≥—Ä—É–ø–ø—ã"]:
        await query.edit_message_text("‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø")
        return
    
    group_id = admin["–≥—Ä—É–ø–ø—ã"][0]["id"]
    settings = get_group_settings(group_id)
    
    if limit_str == "off":
        settings["—Ñ–ª—É–¥"]["–≤–∫–ª—é—á–µ–Ω–æ"] = False
        confirm_text = "‚ùå –§–ª—É–¥-–∫–æ–Ω—Ç—Ä–æ–ª—å –≤—ã–∫–ª—é—á–µ–Ω."
    else:
        try:
            limit = int(limit_str)
            settings["—Ñ–ª—É–¥"]["–≤–∫–ª—é—á–µ–Ω–æ"] = True
            settings["—Ñ–ª—É–¥"]["–ª–∏–º–∏—Ç"] = limit
            confirm_text = f"‚úÖ –§–ª—É–¥-–∫–æ–Ω—Ç—Ä–æ–ª—å: {limit} —Å–æ–æ–±—â–µ–Ω–∏–π / 10 —Å–µ–∫."
        except ValueError:
            confirm_text = "‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞."
    
    save_group_settings(group_id, settings)
    
    await query.edit_message_text(
        confirm_text,
        reply_markup=get_back_button("flood")
    )

# ================== –û–ë–†–ê–ë–û–¢–ö–ê –û–ü–õ–ê–¢–´ (–î–õ–Ø –°–û–ó–î–ê–¢–ï–õ–Ø) ==================

async def handle_payment_confirmation(query, data, user_id, context):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º"""
    if user_id != CREATOR_ID:
        await query.answer("‚ùå –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏", show_alert=True)
        return
    
    payment_id = data.replace("confirm_", "")
    success, message = tariff_system.confirm_payment(payment_id)
    
    if success:
        new_text = query.message.text + f"\n\n‚úÖ **–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û**\n{datetime.now().strftime('%H:%M')}"
        await query.edit_message_text(new_text, reply_markup=None, parse_mode="Markdown")
        
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
        payment = db.data["–ø–ª–∞—Ç–µ–∂–∏"].get(payment_id)
        if payment:
            admin_id = payment["admin_id"]
            try:
                notification_text = "‚úÖ **–û–ü–õ–ê–¢–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê!**\n\n"
                notification_text += f"–¢–∞—Ä–∏—Ñ: {payment['—Ç–∞—Ä–∏—Ñ'].upper()}\n"
                notification_text += f"–°—É–º–º–∞: {payment['—Å—É–º–º–∞']} —Ä—É–±\n"
                notification_text += f"–ü–µ—Ä–∏–æ–¥: {payment['–ø–µ—Ä–∏–æ–¥']}\n\n"
                notification_text += "–í–∞—à —Ç–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! üéâ\n"
                notification_text += "–ë–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É –≤–æ –≤—Å–µ—Ö –≤–∞—à–∏—Ö –≥—Ä—É–ø–ø–∞—Ö."
                
                await context.bot.send_message(
                    chat_id=admin_id,
                    text=notification_text,
                    parse_mode="Markdown"
                )
            except TelegramError as e:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")
        
        await query.answer("‚úÖ –ü–ª–∞—Ç—ë–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω")
    else:
        await query.answer(f"‚ùå –û—à–∏–±–∫–∞: {message}", show_alert=True)

async def handle_payment_decline(query, data, user_id):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º"""
    if user_id != CREATOR_ID:
        await query.answer("‚ùå –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–∫–ª–æ–Ω—è—Ç—å –ø–ª–∞—Ç–µ–∂–∏", show_alert=True)
        return
    
    payment_id = data.replace("decline_", "")
    decline_text = query.message.text + "\n\n‚ùå **–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:**"
    
    await query.edit_message_text(
        decline_text,
        reply_markup=get_decline_reason_buttons(payment_id),
        parse_mode="Markdown"
    )

async def handle_check_screenshot(query, data, context):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç (—É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –≤–∏–¥)"""
    if query.from_user.id != CREATOR_ID:
        await query.answer("‚ùå –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã", show_alert=True)
        return
    
    payment_id = data.replace("check_", "")
    payment = db.data["–ø–ª–∞—Ç–µ–∂–∏"].get(payment_id)
    
    if not payment or not payment.get("—Å–∫—Ä–∏–Ω—à–æ—Ç"):
        await query.answer("‚ùå –°–∫—Ä–∏–Ω—à–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return
    
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç
        await context.bot.send_photo(
            chat_id=CREATOR_ID,
            photo=payment["—Å–∫—Ä–∏–Ω—à–æ—Ç"],
            caption="üîç **–£–í–ï–õ–ò–ß–ï–ù–ù–´–ô –°–ö–†–ò–ù–®–û–¢ –î–õ–Ø –ü–†–û–í–ï–†–ö–ò**\n\n"
                   "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ—Ç–∞–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞.",
            parse_mode="Markdown"
        )
        await query.answer("‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç")
    except TelegramError as e:
        await query.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}", show_alert=True)

async def handle_tags_menu(query, data):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Ç–µ–≥–æ–≤"""
    if query.from_user.id != CREATOR_ID:
        await query.answer("‚ùå –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–µ–≥–∏", show_alert=True)
        return
    
    payment_id = data.replace("tags_", "")
    await query.edit_message_text(
        "üè∑Ô∏è **–í–´–ë–ï–†–ò–¢–ï –¢–ï–ì –î–õ–Ø –ê–î–ú–ò–ù–ê:**",
        reply_markup=get_tags_menu(payment_id),
        parse_mode="Markdown"
    )

async def handle_statistics(query, data):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
    if query.from_user.id != CREATOR_ID:
        await query.answer("‚ùå –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É", show_alert=True)
        return
    
    # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    admins = db.data["–∞–¥–º–∏–Ω—ã"]
    payments = db.data["–ø–ª–∞—Ç–µ–∂–∏"]
    
    total_admins = len(admins)
    active_admins = 0
    now = datetime.now()
    
    for admin in admins.values():
        end_date = datetime.fromisoformat(admin["–æ–∫–æ–Ω—á–∞–Ω–∏–µ_–ø–æ–¥–ø–∏—Å–∫–∏"])
        if end_date > now:
            active_admins += 1
    
    # –í—ã—Ä—É—á–∫–∞
    revenue = 0
    pending = 0
    for p in payments.values():
        if p["—Å—Ç–∞—Ç—É—Å"] == "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω":
            revenue += p["—Å—É–º–º–∞"]
        elif p["—Å—Ç–∞—Ç—É—Å"] == "–æ–∂–∏–¥–∞–Ω–∏–µ":
            pending += p["—Å—É–º–º–∞"]
    
    # –¢–∞—Ä–∏—Ñ—ã
    tariff_counts = {"standard": 0, "pro": 0, "business": 0}
    for admin in admins.values():
        tariff = admin.get("—Ç–∞—Ä–∏—Ñ", "")
        if tariff in tariff_counts:
            tariff_counts[tariff] += 1
    
    stats_text = "üìä **–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û–ö–£–ü–ê–¢–ï–õ–ï–ô**\n\n"
    stats_text += f"üë• **–í—Å–µ–≥–æ –∞–¥–º–∏–Ω–æ–≤:** {total_admins}\n"
    stats_text += f"‚îú‚îÄ –ê–∫—Ç–∏–≤–Ω—ã–µ: {active_admins}\n"
    stats_text += f"‚îî‚îÄ –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ: {total_admins - active_admins}\n\n"
    
    stats_text += f"üí∞ **–í—ã—Ä—É—á–∫–∞:** {revenue} —Ä—É–±\n"
    stats_text += f"‚îú‚îÄ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: {revenue} —Ä—É–±\n"
    stats_text += f"‚îî‚îÄ –û–∂–∏–¥–∞—é—Ç: {pending} —Ä—É–±\n\n"
    
    stats_text += "üìà **–ü–æ —Ç–∞—Ä–∏—Ñ–∞–º:**\n"
    stats_text += f"‚îú‚îÄ –°—Ç–∞–Ω–¥–∞—Ä—Ç: {tariff_counts['standard']}\n"
    stats_text += f"‚îú‚îÄ –ü–†–û: {tariff_counts['pro']}\n"
    stats_text += f"‚îî‚îÄ –ë–∏–∑–Ω–µ—Å: {tariff_counts['business']}\n\n"
    
    # –¢–æ–ø –∞–¥–º–∏–Ω–æ–≤ –ø–æ –æ–ø–ª–∞—Ç–∞–º
    admin_payments = {}
    for p in payments.values():
        if p["—Å—Ç–∞—Ç—É—Å"] == "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω":
            admin_id = p["admin_id"]
            admin_payments[admin_id] = admin_payments.get(admin_id, 0) + p["—Å—É–º–º–∞"]
    
    if admin_payments:
        top_admins = sorted(admin_payments.items(), key=lambda x: x[1], reverse=True)[:5]
        stats_text += "üèÜ **–¢–æ–ø –∞–¥–º–∏–Ω–æ–≤:**\n"
        for i, (admin_id, amount) in enumerate(top_admins, 1):
            admin = db.get_admin(admin_id)
            name = admin.get("username", admin.get("first_name", f"ID: {admin_id}")) if admin else f"ID: {admin_id}"
            stats_text += f"{i}. {name} - {amount} —Ä—É–±\n"
    
    payment_id = data.replace("stats_", "")
    await query.edit_message_text(
        stats_text,
        reply_markup=get_back_button(f"payment_{payment_id}"),
        parse_mode="Markdown"
    )

async def handle_actions_menu(query, data):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π"""
    if query.from_user.id != CREATOR_ID:
        await query.answer("‚ùå –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–µ–π—Å—Ç–≤–∏—è", show_alert=True)
        return
    
    payment_id = data.replace("actions_", "")
    await query.edit_message_text(
        "üéØ **–í–´–ë–ï–†–ò–¢–ï –î–ï–ô–°–¢–í–ò–ï:**",
        reply_markup=get_actions_menu(payment_id),
        parse_mode="Markdown"
    )

async def handle_add_tag(query, data):
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–≥ –∞–¥–º–∏–Ω—É"""
    if query.from_user.id != CREATOR_ID:
        await query.answer("‚ùå –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–µ–≥–∏", show_alert=True)
        return
    
    # data format: tag_[tag]_[payment_id]
    parts = data.split("_")
    if len(parts) != 3:
        await query.answer("‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö", show_alert=True)
        return
    
    tag = parts[1]
    payment_id = parts[2]
    payment = db.data["–ø–ª–∞—Ç–µ–∂–∏"].get(payment_id)
    
    if not payment:
        await query.answer("‚ùå –ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return
    
    admin_id = payment["admin_id"]
    admin = db.get_admin(admin_id)
    
    if admin:
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥
        if "—Ç–µ–≥–∏" not in admin:
            admin["—Ç–µ–≥–∏"] = []
        
        tag_names = {
            "vip": "‚≠ê –ü–û–°–¢–û–Ø–ù–ù–´–ô",
            "discount": "üéÅ –°–û –°–ö–ò–î–ö–û–ô",
            "problem": "‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ù–´–ô",
            "premium": "üíé VIP",
            "scammer": "üö´ –ú–û–®–ï–ù–ù–ò–ö"
        }
        
        tag_name = tag_names.get(tag, tag)
        if tag_name not in admin["—Ç–µ–≥–∏"]:
            admin["—Ç–µ–≥–∏"].append(tag_name)
            db.save_cache()
        
        await query.answer(f"‚úÖ –¢–µ–≥ '{tag_name}' –¥–æ–±–∞–≤–ª–µ–Ω")
        await query.edit_message_text(
            f"‚úÖ **–¢–ï–ì –î–û–ë–ê–í–õ–ï–ù:** {tag_name}\n\n"
            f"–ê–¥–º–∏–Ω: {admin.get('username', admin.get('first_name', '–ê–¥–º–∏–Ω'))}\n"
            f"–¢–µ–≥–∏: {', '.join(admin.get('—Ç–µ–≥–∏', []))}",
            reply_markup=get_back_button(f"payment_{payment_id}"),
            parse_mode="Markdown"
        )
    else:
        await query.answer("‚ùå –ê–¥–º–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)

async def handle_admin_action(query, data, context):
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ —Å –∞–¥–º–∏–Ω–æ–º"""
    if query.from_user.id != CREATOR_ID:
        await query.answer("‚ùå –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–µ–π—Å—Ç–≤–∏—è", show_alert=True)
        return
    
    # data format: action_[action]_[payment_id]
    parts = data.split("_")
    if len(parts) != 3:
        await query.answer("‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö", show_alert=True)
        return
    
    action = parts[1]
    payment_id = parts[2]
    payment = db.data["–ø–ª–∞—Ç–µ–∂–∏"].get(payment_id)
    
    if not payment:
        await query.answer("‚ùå –ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return
    
    admin_id = payment["admin_id"]
    admin = db.get_admin(admin_id)
    
    if not admin:
        await query.answer("‚ùå –ê–¥–º–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return
    
    action_texts = {
        "extend": "üÜì +7 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ",
        "upgrade": "üìà –ê–ø–≥—Ä–µ–π–¥ —Ç–∞—Ä–∏—Ñ–∞",
        "downgrade": "üìâ –î–∞—É–Ω–≥—Ä–µ–π–¥ —Ç–∞—Ä–∏—Ñ–∞",
        "block": "üîí –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞",
        "refund": "üí∞ –í—ã–ø–ª–∞—Ç–∞"
    }
    
    action_text = action_texts.get(action, action)
    
    if action == "extend":
        # –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –Ω–∞ 7 –¥–Ω–µ–π
        end_date = datetime.fromisoformat(admin["–æ–∫–æ–Ω—á–∞–Ω–∏–µ_–ø–æ–¥–ø–∏—Å–∫–∏"])
        new_end_date = end_date + timedelta(days=7)
        admin["–æ–∫–æ–Ω—á–∞–Ω–∏–µ_–ø–æ–¥–ø–∏—Å–∫–∏"] = new_end_date.isoformat()
        db.save_cache()
        
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
        try:
            await context.bot.send_message(
                chat_id=admin_id,
                text="üéÅ **–í–´ –ü–û–õ–£–ß–ò–õ–ò –ë–û–ù–£–°!**\n\n"
                     "–°–æ–∑–¥–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏–ª –≤–∞–º +7 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!\n\n"
                     f"–ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {new_end_date.strftime('%d.%m.%Y')}",
                parse_mode="Markdown"
            )
        except TelegramError:
            pass
        
        result = f"‚úÖ –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∏–ª +7 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ"
    
    elif action == "block":
        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–¥–º–∏–Ω–∞
        admin["–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"] = True
        admin["–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞"] = datetime.now().isoformat()
        db.save_cache()
        
        result = f"üö´ –ê–¥–º–∏–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"
    
    else:
        result = f"‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ '{action_text}' –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ"
    
    await query.answer(result)
    await query.edit_message_text(
        f"‚úÖ **–î–ï–ô–°–¢–í–ò–ï –í–´–ü–û–õ–ù–ï–ù–û**\n\n"
        f"–î–µ–π—Å—Ç–≤–∏–µ: {action_text}\n"
        f"–ê–¥–º–∏–Ω: {admin.get('username', admin.get('first_name', '–ê–¥–º–∏–Ω'))}\n"
        f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {result}",
        reply_markup=get_back_button(f"payment_{payment_id}"),
        parse_mode="Markdown"
    )

# ================== –û–ë–†–ê–ë–û–¢–ö–ê –ë–ê–ù–û–í ==================

async def handle_unban(query, data, context):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–±–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    parts = data.split("_")
    if len(parts) != 3:
        await query.answer("‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö", show_alert=True)
        return
    
    user_id = int(parts[1])
    group_id = int(parts[2])
    
    try:
        # –†–∞–∑–±–∞–Ω–∏–≤–∞–µ–º
        await context.bot.unban_chat_member(
            chat_id=group_id,
            user_id=user_id,
            only_if_banned=True
        )
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞—Ä—É—à–µ–Ω–∏—è
        db.reset_violations(group_id, user_id)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        new_text = query.message.text + "\n\nüîÑ **–†–ê–ó–ë–ê–ù–ï–ù**\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–∞–Ω–µ–Ω."
        await query.edit_message_text(new_text, reply_markup=None, parse_mode="Markdown")
        
        await query.answer("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–∞–Ω–µ–Ω")
        
    except TelegramError as e:
        await query.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}", show_alert=True)

async def handle_ban_details(query, data):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –±–∞–Ω–∞"""
    parts = data.split("_")
    if len(parts) != 3:
        await query.answer("‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö", show_alert=True)
        return
    
    user_id = int(parts[1])
    group_id = int(parts[2])
    
    violations_data = db.get_violations(group_id, user_id)
    
    details_text = "üîç **–ü–û–î–†–û–ë–ù–û–°–¢–ò –ë–ê–ù–ê**\n\n"
    details_text += f"üë§ **ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** {user_id}\n"
    details_text += f"üìç **–ì—Ä—É–ø–ø–∞ ID:** {group_id}\n\n"
    
    if violations_data["–Ω–∞—Ä—É—à–µ–Ω–∏—è"]:
        details_text += "üìù **–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏–π:**\n"
        for i, violation in enumerate(violations_data["–Ω–∞—Ä—É—à–µ–Ω–∏—è"], 1):
            time = datetime.fromisoformat(violation["–≤—Ä–µ–º—è"]).strftime("%H:%M")
            reason = violation["–ø—Ä–∏—á–∏–Ω–∞"]
            message = violation["—Å–æ–æ–±—â–µ–Ω–∏–µ"]
            
            details_text += f"{i}. {time} ‚Äî {reason}\n"
            if message:
                details_text += f"   üí¨ {message[:50]}...\n"
    else:
        details_text += "üìù –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç\n\n"
    
    details_text += f"\nüéØ **–í—Å–µ–≥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π:** {violations_data['–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è']}/3"
    
    await query.edit_message_text(
        details_text,
        reply_markup=get_ban_full_details_buttons(user_id, group_id),
        parse_mode="Markdown"
    )

# ================== –û–ë–†–ê–ë–û–¢–ö–ê –§–û–¢–û (–°–ö–†–ò–ù–®–û–¢–´) ==================

async def handle_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –æ–ø–ª–∞—Ç—ã"""
    user_id = update.effective_user.id
    
    if user_id not in current_payments:
        await update.message.reply_text(
            "‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –¥–ª—è –æ–ø–ª–∞—Ç—ã.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /tariffs"
        )
        return
    
    payment_data = current_payments[user_id]
    photo_id = update.message.photo[-1].file_id
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–∞—Ç—ë–∂
    db.update_payment(payment_data["payment_id"], "—Å–∫—Ä–∏–Ω—à–æ—Ç_–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω", photo_id)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥–º–∏–Ω–µ
    admin = get_admin_info(user_id, update)
    admin_username = admin.get("username", update.effective_user.username or "–±–µ–∑_username")
    admin_name = admin.get("first_name", update.effective_user.first_name or "–ê–¥–º–∏–Ω")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—é
    try:
        message = f"üí∞ **–ù–û–í–ê–Ø –û–ü–õ–ê–¢–ê** #{payment_data['payment_id']}\n\n"
        message += f"üë§ **–ê–¥–º–∏–Ω:** {admin_name} (@{admin_username})\n"
        message += f"üí≥ **–¢–∞—Ä–∏—Ñ:** {payment_data['tariff']}\n"
        message += f"üí∞ **–°—É–º–º–∞:** {payment_data['amount']} —Ä—É–±\n"
        message += f"üìÖ **–ü–µ—Ä–∏–æ–¥:** {payment_data['period_text']}\n"
        message += f"‚è∞ **–í—Ä–µ–º—è:** {datetime.now().strftime('%d.%m.%Y %H:%M')}\n"
        message += "\n‚è≥ **–°—Ç–∞—Ç—É—Å:** –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
        
        await context.bot.send_photo(
            chat_id=CREATOR_ID,
            photo=photo_id,
            caption=message,
            reply_markup=get_payment_confirmation_buttons(payment_data['payment_id']),
            parse_mode="Markdown"
        )
        
        response_text = "‚úÖ **–°–ö–†–ò–ù–®–û–¢ –ü–û–õ–£–ß–ï–ù!**\n\n"
        response_text += "–û–ø–ª–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ–∑–¥–∞—Ç–µ–ª—é.\n"
        response_text += "–û–±—ã—á–Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ 24 —á–∞—Å–æ–≤.\n\n"
        response_text += "–í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –ø–ª–∞—Ç—ë–∂ –±—É–¥–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω."
        
    except TelegramError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—é: {e}")
        response_text = "‚ùå **–û–®–ò–ë–ö–ê –û–¢–ü–†–ê–í–ö–ò!**\n\n"
        response_text += "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—é.\n"
        response_text += "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."
    
    # –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–ª–∞—Ç—ë–∂
    if user_id in current_payments:
        del current_payments[user_id]
    
    await update.message.reply_text(response_text, parse_mode="Markdown")

# ================== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ë–û–¢–ê –í –ì–†–£–ü–ü–£ ==================

async def handle_new_chat_members(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É"""
    if not update.message or not update.message.new_chat_members:
        return
    
    bot_id = context.bot.id
    for new_member in update.message.new_chat_members:
        if new_member.id == bot_id:
            # –ë–æ—Ç–∞ –¥–æ–±–∞–≤–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É
            chat_id = update.effective_chat.id
            chat_title = update.effective_chat.title or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"
            admin_id = update.effective_user.id
            
            logger.info(f"–ë–æ—Ç–∞ –¥–æ–±–∞–≤–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É {chat_id} ({chat_title}) –∞–¥–º–∏–Ω–æ–º {admin_id}")
            
            admin = get_admin_info(admin_id, update)
            current_groups = len(admin["–≥—Ä—É–ø–ø—ã"])
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –≥—Ä—É–ø–ø
            can_add = tariff_system.can_add_group(admin_id, current_groups)
            
            if not can_add:
                # –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç
                tariff_type = tariff_system.get_tariff_for_admin(admin_id)
                tariff = TARIFFS.get(tariff_type, {})
                max_groups = tariff.get("groups", 1)
                
                warning_text = f"‚ùå **–ü–†–ï–í–´–®–ï–ù –õ–ò–ú–ò–¢ –ì–†–£–ü–ü!**\n\n"
                warning_text += f"–í–∞—à —Ç–∞—Ä–∏—Ñ: {tariff.get('name', '–ü—Ä–æ–±–Ω—ã–π')}\n"
                warning_text += f"–î–æ—Å—Ç—É–ø–Ω–æ –≥—Ä—É–ø–ø: {current_groups}/{max_groups}\n\n"
                warning_text += "–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –≥—Ä—É–ø–ø, –æ–±–Ω–æ–≤–∏—Ç–µ —Ç–∞—Ä–∏—Ñ."
                
                await update.message.reply_text(warning_text, parse_mode="Markdown")
                
                # –ü–æ–∫–∏–¥–∞–µ–º –≥—Ä—É–ø–ø—É
                try:
                    await context.bot.leave_chat(chat_id)
                except TelegramError:
                    pass
                
                # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
                try:
                    await context.bot.send_message(
                        chat_id=admin_id,
                        text=f"–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É '{chat_title}'.\n"
                             f"–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –≥—Ä—É–ø–ø –≤–∞—à–µ–≥–æ —Ç–∞—Ä–∏—Ñ–∞.\n\n"
                             f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /tariffs –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–æ–≤–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞."
                    )
                except TelegramError:
                    pass
                
                return
            
            # –°–æ–∑–¥–∞—ë–º –≥—Ä—É–ø–ø—É
            db.create_group(chat_id, chat_title, admin_id)
            db.add_admin_group(admin_id, chat_id, chat_title)
            
            # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            welcome_text = "ü§ñ **ANTI-SPAM BOT –ê–ö–¢–ò–í–ò–†–û–í–ê–ù!**\n\n"
            welcome_text += "–Ø –±—É–¥—É –∑–∞—â–∏—â–∞—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É –æ—Ç:\n"
            welcome_text += "‚Ä¢ –°–ø–∞–º–∞ –∏ —Ä–µ–∫–ª–∞–º—ã\n"
            welcome_text += "‚Ä¢ –ú–∞—Ç–µ—Ä–Ω—ã—Ö —Å–ª–æ–≤\n"
            welcome_text += "‚Ä¢ –§–ª—É–¥–∞ –∏ —Å—Å—ã–ª–æ–∫\n"
            welcome_text += "‚Ä¢ –ù–æ–≤—ã—Ö –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤\n\n"
            welcome_text += "‚öôÔ∏è –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: /start\n"
            welcome_text += "üí∞ –¢–∞—Ä–∏—Ñ—ã –∏ –æ–ø–ª–∞—Ç–∞: /tariffs"
            
            await update.message.reply_text(welcome_text, parse_mode="Markdown")
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
            try:
                admin_dm_text = f"‚úÖ –ë–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É ¬´{chat_title}¬ª\n\n"
                admin_dm_text += f"–ì—Ä—É–ø–ø–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: {current_groups + 1}/{tariff.get('groups', 1)}\n\n"
                admin_dm_text += "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ—Ç–∞: /settings\n"
                admin_dm_text += "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞—Ä–∏—Ñ: /tariffs"
                
                await context.bot.send_message(
                    chat_id=admin_id,
                    text=admin_dm_text
                )
            except TelegramError:
                pass
            
            break

# ================== FLASK WEB SERVER ==================

def run_web_server():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏"""
    from flask import Flask, jsonify
    
    app = Flask(__name__)
    
    @app.route('/')
    def home():
        return """
        <!DOCTYPE html>
        <html>
        <head>
            <title>ü§ñ Anti-Spam Bot</title>
            <meta charset="UTF-8">
            <style>
                body {
                    font-family: Arial, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    margin: 0;
                    color: white;
                }
                .container {
                    background: rgba(255, 255, 255, 0.1);
                    backdrop-filter: blur(10px);
                    padding: 40px;
                    border-radius: 20px;
                    text-align: center;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                }
                h1 {
                    font-size: 2.5em;
                    margin-bottom: 20px;
                }
                .status {
                    font-size: 1.2em;
                    background: rgba(0, 255, 0, 0.2);
                    padding: 10px 20px;
                    border-radius: 50px;
                    display: inline-block;
                    margin-bottom: 30px;
                }
                .links {
                    display: flex;
                    gap: 20px;
                    justify-content: center;
                }
                .link {
                    background: rgba(255, 255, 255, 0.2);
                    padding: 10px 20px;
                    border-radius: 10px;
                    text-decoration: none;
                    color: white;
                    transition: 0.3s;
                }
                .link:hover {
                    background: rgba(255, 255, 255, 0.3);
                    transform: translateY(-5px);
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ü§ñ Telegram Anti-Spam Bot</h1>
                <div class="status">üü¢ STATUS: RUNNING</div>
                <p>Port: 8080 | Uptime: Active</p>
                <div class="links">
                    <a href="/health" class="link">Health Check</a>
                    <a href="/metrics" class="link">Metrics</a>
                </div>
            </div>
        </body>
        </html>
        """
    
    @app.route('/health')
    def health():
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
        return jsonify({
            "status": "ok",
            "service": "telegram-anti-spam-bot",
            "timestamp": datetime.now().isoformat(),
            "version": "1.0.0"
        }), 200
    
    @app.route('/metrics')
    def metrics():
        """–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
        import psutil
        metrics_data = {
            "bot_status": "running",
            "timestamp": datetime.now().isoformat(),
            "system": {
                "cpu_percent": psutil.cpu_percent(),
                "memory_percent": psutil.virtual_memory().percent,
                "disk_percent": psutil.disk_usage('/').percent
            },
            "bot_stats": {
                "admins_count": len(db.data["–∞–¥–º–∏–Ω—ã"]),
                "groups_count": len(db.data["–≥—Ä—É–ø–ø—ã"]),
                "payments_count": len(db.data["–ø–ª–∞—Ç–µ–∂–∏"]),
                "violations_count": len(db.data["–Ω–∞—Ä—É—à–∏—Ç–µ–ª–∏"])
            }
        }
        return jsonify(metrics_data), 200
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
    app.run(host='0.0.0.0', port=8080, debug=False, use_reloader=False)

# ================== –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö ==================

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.error(f"–û—à–∏–±–∫–∞: {context.error}", exc_info=context.error)
    
    try:
        if update and update.effective_chat:
            await context.bot.send_message(
                chat_id=update.effective_chat.id,
                text="‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )
    except:
        pass

# ================== MAIN ==================

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    print("üöÄ –ó–∞–ø—É—Å–∫ Anti-Spam Bot...")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    web_thread = threading.Thread(target=run_web_server, daemon=True)
    web_thread.start()
    print("üåê –í–µ–±-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8080")
    
    # –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ—Ç–∞
    app = Application.builder().token(TOKEN).build()
    
    # ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ==========
    app.add_handler(CommandHandler("start", start_command))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("tariffs", tariffs_command))
    app.add_handler(CommandHandler("settings", settings_command))
    
    # ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–û–ë–©–ï–ù–ò–ô ==========
    app.add_handler(MessageHandler(filters.StatusUpdate.NEW_CHAT_MEMBERS, handle_new_chat_members))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, analyze_message))
    app.add_handler(MessageHandler(filters.PHOTO, handle_photo))
    
    # ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò CALLBACK ==========
    app.add_handler(CallbackQueryHandler(handle_callback_query))
    
    # ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –û–®–ò–ë–û–ö ==========
    app.add_error_handler(error_handler)
    
    print("ü§ñ Anti-Spam Bot –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    print("üìû –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
    print("üåê –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8080")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    app.run_polling(allowed_updates=Update.ALL_TYPES)

# ================== –ó–ê–ü–£–°–ö ==================

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nüëã –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...")
        db.save_cache()
        print("üíæ –ö—ç—à —Å–æ—Ö—Ä–∞–Ω—ë–Ω")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        db.save_cache()
        raise