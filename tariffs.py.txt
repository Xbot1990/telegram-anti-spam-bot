from datetime import datetime, timedelta
from config import TARIFFS, PAYMENT_DETAILS, CREATOR_ID
import logging
logger = logging.getLogger(__name__)

class TariffSystem:
    def __init__(self, database):
        self.db = database
    def get_tariff_description(self, tariff_type):
        tariff = TARIFFS.get(tariff_type)
        if not tariff: return "Ð¢Ð°Ñ€Ð¸Ñ„ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        description = f"ðŸ¤– **Ð¢ÐÐ Ð˜Ð¤ Â«{tariff['name'].upper()}Â»**\n\n"
        if tariff_type == "trial":
            description += "ðŸŽ **30 Ð´Ð½ÐµÐ¹ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾**\n\n"
        else:
            description += f"ðŸ“† **ÐœÐµÑÑÑ†:** {tariff['price_month']} Ñ€ÑƒÐ±\n\n"
        description += "âœ… **Ð’ÐšÐ›Ð®Ð§ÐÐ•Ð¢:**\n"
        if tariff_type == "trial": description += "â€¢ 1 Ð³Ñ€ÑƒÐ¿Ð¿Ð°\nâ€¢ Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹\nâ€¢ Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð² Ð›Ð¡"
        elif tariff_type == "standard": description += "â€¢ 3 Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹\nâ€¢ Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹\nâ€¢ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼Ð¸"
        elif tariff_type == "pro": description += "â€¢ 10 Ð³Ñ€ÑƒÐ¿Ð¿\nâ€¢ Ð£Ð¼Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼\nâ€¢ Ð’ÐµÐ±-Ð¿Ð°Ð½ÐµÐ»ÑŒ"
        else: description += "â€¢ Ð‘ÐµÐ·Ð»Ð¸Ð¼Ð¸Ñ‚ Ð³Ñ€ÑƒÐ¿Ð¿\nâ€¢ White-label\nâ€¢ API Ð´Ð¾ÑÑ‚ÑƒÐ¿"
        return description
    def get_tariff_for_admin(self, admin_id):
        admin = self.db.get_admin(admin_id)
        if not admin: return "trial"
        end_date = datetime.fromisoformat(admin["Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ðµ_Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸"])
        if datetime.now() > end_date:
            self.db.update_admin_tariff(admin_id, "trial")
            return "trial"
        return admin["Ñ‚Ð°Ñ€Ð¸Ñ„"]
    def can_add_group(self, admin_id, current_groups_count):
        tariff_type = self.get_tariff_for_admin(admin_id)
        tariff = TARIFFS.get(tariff_type)
        if not tariff: return False
        if tariff["groups"] == 999: return True
        return current_groups_count < tariff["groups"]
    def process_payment_selection(self, admin_id, tariff_type, period):
        tariff = TARIFFS.get(tariff_type)
        if not tariff: return None
        amount = tariff["price_month"]
        days = 30
        payment = self.db.create_payment(admin_id, tariff_type, amount, period)
        return {"payment_id": payment["id"], "tariff": tariff["name"], "amount": amount, "days": days}
    def confirm_payment(self, payment_id):
        payment = self.db.data["Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð¸"].get(payment_id)
        if not payment: return False, "ÐŸÐ»Ð°Ñ‚Ñ‘Ð¶ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        if payment["ÑÑ‚Ð°Ñ‚ÑƒÑ"] == "Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½": return False, "Ð£Ð¶Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ñ‘Ð½"
        self.db.update_payment(payment_id, "Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½")
        admin_id = payment["admin_id"]
        tariff_type = payment["Ñ‚Ð°Ñ€Ð¸Ñ„"]
        self.db.update_admin_tariff(admin_id, tariff_type, 30)
        logger.info(f"ÐŸÐ»Ð°Ñ‚Ñ‘Ð¶ {payment_id} Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ñ‘Ð½")
        return True, "Ð¢Ð°Ñ€Ð¸Ñ„ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½"